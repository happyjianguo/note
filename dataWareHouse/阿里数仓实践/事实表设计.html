<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>事实表设计</title>
	</head>
<body>
<h1>事实表设计</h1>

<hr />

<h2>事实表基础</h2>

<h3>事实表特性</h3>

<p>事实表作为数据仓库维度建模的核心，紧紧围绕着业务过程来设计，<strong>通过获取描述业务过程的度量来表达业务过程</strong>，包含了<strong>引用的维度</strong>和<strong>与业务过程有关的度量</strong>。</p>

<p><strong>事实表中一条记录所表达的业务细节程度被称为粒度</strong>。通常粒度可以通过两种方式来表述：</p>

<ul>
	<li>一种是维度属性组合所表示的细节程度；</li>
	<li>一种是所表示的具体业务含义</li>
</ul>

<p>作为度量业务过程的事实，一般为整型或浮点型的十进制数值，有三种类型：</p>

<ul>
	<li>可加性：可以按照与事实表关联的任意维度进行汇总；</li>
	<li>半可加性：只能按照特定维度汇总，对其他维度汇总时没有业务意义；</li>
	<li>不可加性：完全不具备可加性，比如比率型事实</li>
</ul>

<p>事实表有三种类型：</p>

<ul>
	<li>事务事实表</li>
	<li>周期快照事实表

		<p>以具有规律性的、可预见的时间间隔记录事实；</p></li>
	<li>累积快照事实表

		<p>用来表述过程开始和结束之间的关键步骤事件，覆盖过程的整个生命周期，通常具有多个日期字段来记录关键时间点，当过程随着生命周期不断变化时，记录也会随着过程的变化而被修改。</p></li>
</ul>

<h3>事实表设计原则</h3>

<h4>尽可能包含所有与业务过程相关的事实</h4>

<p>事实表设计的目的是为了度量业务过程，因此分析哪些事实与业务过程有关是设计中非常重要的关注点，在事实表中应该尽量包含所有与业务过程相关的事实。</p>

<h4>只选择与业务过程相关的事实</h4>

<p>如下单这个业务过程，不应该存在支付金额这个表示支付业务过程的事实。</p>

<h4>分解不可加性事实为可加的组件</h4>

<p>对于不具备可加性条件的事实，需要分解为可加的组件。</p>

<p>如订单的优惠率，应该分解为订单原价金额和订单优惠金额两个事实存在事实表中。</p>

<h4>在选择维度和事实之前必须先声明粒度</h4>

<p>粒度用于确定事实表中一行所表示业务的细节层次，决定了维度模型的扩展性，在选择维度和事实之前必须先声明粒度，且每个维度和事实必须与所定义的粒度保持一致。</p>

<p>粒度定义越细越好，这样能提供最大限度的灵活性，支持无法预期的各种细节层次的用户需求。</p>

<h4>在同一个事实表中不能有多种不同粒度的事实</h4>

<p>事实表中所有事实需要与表定义的粒度保持一致，在同一个事实表中不能有多种不同粒度的事实。</p>

<h4>事实的单位要保持一致</h4>

<p>对于同一个事实表中事实的单位，应该采用一致的计量单位。</p>

<h4>对事实的null值要处理</h4>

<p>方便数据在数据库中计算处理。</p>

<h4>使用退化维度提供事实表的易用性</h4>

<p>维度属性也可以存储到事实表中，这种存储到事实表中的维度称为<strong>退化维度</strong>。可以减少下游用户使用时关联多个表的操作，通过增加冗余存储的方式减少计算开销，提高使用效率。</p>

<h3>事实表设计方法</h3>

<h4>选择业务过程及确定事实表类型</h4>

<p>明确业务需求之后，需要进行详细的需求分析，对业务的整个生命周期进行分析，明确关键的业务步骤，从而选择与需求有关的业务过程。</p>

<p>选择了业务过程之后，相应的事实表类型也随之确定了。比如选择了单一业务过程，事实表类型就是单事务事实表；选择多个业务过程，并且需要分析各个业务过程之间的时间间隔，那么所建立的事实表应为包含了所有业务过程的累积快照事实表。</p>

<h4>声明粒度</h4>

<p>粒度的声明意味着精确定义事实表的每一行所表示的业务含义，粒度传递的是与事实表度量有关的细节层次。明确的粒度能确保对事实表中行的意思的理解不会产生混淆，保证所有的事实按照同样的细节层次记录。</p>

<p>应该尽量选择最细级别的原子粒度，以确保事实表的应用具有最大的灵活性。</p>

<h4>确定维度</h4>

<p>完成粒度声明以后，也就意味着确定了主键，对应的维度组合以及相关的维度字段就可以确定了，应该选择能够描述清楚业务过程所处的环境的维度信息。</p>

<h4>确定事实</h4>

<p>事实可以通过回答“过程的度量是什么”来确定。应该选择与业务过程有关的所有事实，且事实的粒度要与所声明的事实表的粒度一致。</p>

<h4>冗余维度</h4>

<p>传统维度建模的星型模型一般将维度存放在维度表中，通过事实表的外键获取维度，来减少事实表的维度冗余。</p>

<p>而在大数据的事实表模型设计中，为了提高下游用户的使用效率，降低数据获取的复杂性，减少关联表数量，一般事实表中会冗余方便下游用户使用的常用维度。</p>

<hr />

<h2>事务事实表</h2>

<p>任何类型的事件都可以被理解为一种事务。</p>

<p><strong>事务事实表，即针对业务过程构建的一类事实表，用以跟踪定义业务过程的个体行为</strong>，提供丰富的分析能力，作为数据仓库原子的明细数据。</p>

<h3>设计过程</h3>

<p>以淘宝交易事务事实表为例：</p>

<figure><img src="/Users/xerxes/note/dataWareHouse/src/%E6%B7%98%E5%AE%9D%E4%BA%A4%E6%98%93%E4%BA%8B%E5%8A%A1%E4%BA%8B%E5%AE%9E%E8%A1%A8.jpg"/></figure>

<h4>选择业务过程</h4>

<p>整理淘宝交易订单的流转过程，其中有4个重要过程：创建订单、买家付款、卖家发货、买家确认收货四个业务过程。这四个业务过程不仅是交易过程中的重要时间节点，而且也是下游统计分析的重点，因此淘宝交易事务事实表设计着重从这四个业务过程进行展开。</p>

<h4>确定粒度</h4>

<p>业务背景：将多种商品加入到购物车中一起结算，对于同一个店铺额外产生一个订单，即父订单，父订单承载订单物流、店铺优惠等信息；对于每一种商品都会产生一个子订单，子订单记录了父订单的订单号，并且有子订单标志。</p>

<p>上一步确定了四个重要的业务过程，需要为每个业务过程确定一个粒度。</p>

<p>其中创建订单、买家付款、买家确认收货三个业务过程选择交易子订单粒度，即每个子订单为事务事实表的一行，每个子订单所表达的细节信息为：交易时间、卖家、买家、商品。</p>

<p>卖家发货这个业务过程选择物流单粒度，同一个子订单拆开成多个物流单进行发货。</p>

<h4>确定维度</h4>

<p>按照经常用于统计分析的场景，确定维度包含：买家、卖家、商品、商品类目、发货地区、收货地区、父订单维度。另外订单的业务类型等使用较多却无法归属到上述维度中，则新建一个杂项维度。</p>

<h4>确定事实</h4>

<p>该例选定的业务过程拥有不同的事实，如创建订单业务过程需要包含下单金额、下单数量等；买家付款包含支付金额、折扣金额等；买家确认收货业务过程包含确认收货金额等。</p>

<p>由于粒度是子订单，对于一些父订单上的金额需要分摊到子订单上，需要相应的分摊算法。</p>

<h4>冗余维度</h4>

<p>将买卖家星级、标签、店铺名称、商品类型等维度属性都冗余到事实表，提高对事实表进行过滤查询、统计聚合的效率。</p>

<h3>单事务事实表</h3>

<p>针对每个业务过程设计一个事实表。方便针对每个业务过程进行独立的分析研究。</p>

<h3>多事务事实表</h3>

<p>将不同的事实放在同一个事实表中，即同一个事实表包含不同的业务过程。</p>

<p>事实的处理有两种方法：</p>

<ul>
	<li>不同业务过程的事实使用不同的事实字段进行存放;</li>
	<li>不同业务过程的事实使用同一个事实字段进行存放，但增加一个业务过程标签</li>
</ul>

<h4>多事务事实表的选择</h4>

<p>当不同业务过程的度量比较相似，差异不大时，可以采用第二种多事务事实表的设计方式，使用同一个字段来表示度量数据。</p>

<p>当不同业务过程的度量差异较大时，可以选择第一种多事务事实表的设计方式，将不同业务过程的度量使用不同字段冗余到表中，非当前业务过程则置零。</p>

<h3>两种事实表对比</h3>

<h4>业务过程</h4>

<p>多个业务过程是否放到同一个事实表中，首先需要分析不同业务过程之间的相似性和业务源系统。</p>

<h4>粒度和维度</h4>

<p>当不同业务过程的粒度相同，同时拥有相似的维度，就可以考虑采用多事务事实表。粒度不同，必定是不同的事实表。</p>

<h4>事实</h4>

<p>如果单一业务过程的事实较多，同时不同业务过程的事实又不相同，则可以考虑使用单事务事实表，处理更加清晰；若使用多事务事实表，则会导致事实表零值或空值字段较多。</p>

<h4>下游业务使用</h4>

<p>单事务事实表对于下游用户而言更容易理解，关注那个业务过程就使用相应的事务事实表。</p>

<h4>计算存储成本</h4>

<p>当业务过程数据来源于同一个业务系统，具有相同的粒度和维度，且维度较多而事实相对不多时，可以考虑多事务事实表。不仅加工计算成本较低，同时在存储上也相对节省。</p>

<h3>父子事实的处理方式</h3>

<p>面对父订单对应多笔子订单的情况，事务事实表按照最细粒度原则选择子订单粒度，通过分摊父订单的金额将所有业务过程的度量全部带进事务事实表中。</p>

<h3>事实的设计准则</h3>

<h4>事实完整性</h4>

<p>事实表包含与其描述的过程有关的所有事实，即尽可能多的获取所有的度量。</p>

<h4>事实一致性</h4>

<p>在确定事务事实表的事实时，明确存储每一个事实以确保度量的一致性。</p>

<h4>事实可加性</h4>

<p>事务事实表中关注更多的是可加性事实。</p>

<hr />

<h2>周期快照事实表</h2>

<p>针对不同的业务场景，事务事实表无法满足所有的需求。如统计历史至今的卖家下单金额，通过事务事实表聚集效率较低，而采用周期快照事实表则是可行的。</p>

<h3>特性</h3>

<h4>用快照采样状态</h4>

<p><strong>快照事实表以预定的间隔采样状态度量。这种间隔联合一个或多个维度，将被用来定义快照事实表的粒度，每行都将包含记录所涉及状态的事实</strong>。</p>

<h4>快照粒度</h4>

<p><strong>快照事实表的粒度通常总是被多维声明</strong>，可以简单地理解为快照需要采样的周期以及什么将被采样。</p>

<p>如交易卖家快照事实表，粒度可以被理解为每天针对卖家的历史截止当日的下单支付金额进行快照。</p>

<h4>密度与稠密性</h4>

<p>快照事实表和事务事实表的一个关键区别在密度上。</p>

<p>事务事实表是稀疏的，只有当天发生的业务过程，事实表才会记录该业务过程的事实；而<strong>快照事实表是稠密的，无论当天是否有业务过程发生，都会记录一行</strong>。</p>

<h4>半可加性</h4>

<p><strong>在快照事实表中收集到的状态度量都是半可加的</strong>。半可加性事实不能根据时间维度获得有意义的汇总结果。</p>

<h3>实例</h3>

<p>对于快照事实表的设计步骤，可以归纳为：</p>

<ul>
	<li>确定快照事实表的快照粒度；</li>
	<li>确定快照事实表采样的状态度量</li>
</ul>

<p>周期快照事实表产出模式：</p>

<ul>
	<li>从事务事实表进行汇总产出；</li>
	<li>直接使用ODS 层的数据进行加工</li>
</ul>

<h3>注意事项</h3>

<h4>事务与快照成对设计</h4>

<p>在进行维度建模时对于事务事实表和快照事实表往往都是成对设计的，互相补充，以满足更多的下游统计分析需求，特别是在事务事实表的基础上加工快照事实表，既丰富了星型模型，又降低了下游分析的成本。</p>

<h4>附加事实</h4>

<p>快照事实表在确定状态度量时，一般都是保存采样周期结束时的状态度量。</p>

<p>但是也有分析需求需要关注上一个采样周期结束时的状态度量，而又不愿意多次使用快照事实表，因此一般在设计周期快照事实表时附加一些上一个采样周期的状态度量。</p>

<h4>周期到日期度量</h4>

<p>在设计周期快照事实表度量时，需要考虑自然年至今、季度至今等一些状态度量，以满足更多的统计分析需求。</p>

<hr />

<h2>累积快照事实表</h2>

<p>对于一些统计买家下单到支付的时长、买家支付到卖家发货的时长、买家从下单到确认收货的时长等，使用事务事实表统计逻辑复杂且性能较差。这类统计事件之间时间间隔的需求，采用累积快照事实表更为合理。</p>

<h3>特点</h3>

<h4>数据不断更新</h4>

<p>事务事实表记录事务发生时的状态，对于实体的某一实例不再更新；而累积快照事实表则对实体的某一实例定期更新。</p>

<p>如下图所示，事务事实表对于一笔订单，创建、支付和确认收货都会产生一条新的记录；而累积快照事实表只会有一条记录：</p>

<figure><img src="/Users/xerxes/note/dataWareHouse/src/%E7%B4%AF%E7%A7%AF%E5%BF%AB%E7%85%A7%E4%BA%8B%E5%AE%9E%E8%A1%A8.png"/></figure>

<h4>短生命周期</h4>

<p>累积快照事实表适用于具有明确起止时间的短生命周期的实体，比如交易订单、物流订单等。对于商品、用户等具有长生命周期的实体，一般采用周期快照事实表更合适。</p>

<h4>多业务过程日期</h4>

<p>累积快照事实表的典型特征是多业务过程日期，用于计算业务过程之间的时间间隔。</p>

<p>还有一个作用是保存全量数据。对于交易，需要保留历史截止当前的所有交易数据，其中一种方式是在ODS 层保留和源系统结构完全相同的数据，但使用不方便，因此在公共明细层使用累积快照事实表保留一份全量数据。</p>

<hr />

<h2>三种事实表的比较</h2>

<figure><img src="/Users/xerxes/note/dataWareHouse/src/%E4%B8%89%E7%A7%8D%E4%BA%8B%E5%AE%9E%E8%A1%A8%E6%AF%94%E8%BE%83.png"/></figure>

<p>事务事实表记录事务层面的事实，用于跟踪业务过程的行为，保存最原子的数据，粒度通常是每个事务一条记录。</p>

<p>周期快照事实表以具有规律性的、可预见的时间间隔来记录事实，如余额、库存等，时间间隔为每天、每月等。周期快照事实表的日期维度通常记录时间段的终止日，记录的事实就是这个时间段内一些状态度量。</p>

<p>累积快照事实表用来跟踪实体的一系列业务过程的进展情况，通常具有多个日期字段，用于研究业务过程中的阶段的时间间隔。</p>

<hr />

<h2>无事实的事实表</h2>

<p>无事实的事实表虽然没有明确的事实，但可以用来支持业务过程的度量。</p>

<p>常见的无事实的事实表主要有两种：</p>

<ul>
	<li>事件类：记录事件的发生，最常见的是日志类事实表；</li>
	<li>条件、范围或资格类：记录维度与维度多对多之间的关系，如产品的促销范围</li>
</ul>

<hr />

<h2>聚集型事实表</h2>

<p>聚集主要是通过汇总明细粒度数据来获得改进查询性能的效果。</p>

<p>将频繁使用的公用数据，通过聚集进行沉淀，如卖家最近一天交易汇总表。</p>

<h3>聚集的基本原则</h3>

<ul>
	<li>一致性：聚集表必须提供与查询明细粒度数据一致的查询结果；</li>
	<li>避免单一表设计：不要在同一个表中存储不同层次的聚集数据，通用做法是在聚集时显式地加入数据层级列以示区别，或者把按天与按月汇总的交易额用两列存放，但是需要在列名或者列注释上能分辨出来；</li>
	<li>聚集粒度可不同：聚集并不需要保持与原始明细粒度数据一样的粒度，聚集只关心所需要查询的维度，如按照商品汇总一天的交易额</li>
</ul>

<h3>聚集的基本步骤</h3>

<ol>
	<li>确定聚集维度</li>
	<li>确定一致性上钻</li>
	<li>确定聚集事实</li>
</ol>

</body>
</html>

