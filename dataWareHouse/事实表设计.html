<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>事实表设计</title>
	</head>
<body>
<h1>事实表设计</h1>

<hr />

<h2>事实表基础</h2>

<h3>事实表特性</h3>

<p>事实表作为数据仓库维度建模的核心，紧紧围绕着业务过程来设计，<strong>通过获取描述业务过程的度量来表达业务过程</strong>，包含了<strong>引用的维度</strong>和<strong>与业务过程有关的度量</strong>。</p>

<p><strong>事实表中一条记录所表达的业务细节程度被称为粒度</strong>。通常粒度可以通过两种方式来表述：一种是维度属性组合所表示的细节程度；一种是所表示的具体业务含义。</p>

<p>作为度量业务过程的事实，一般为整型或浮点型的十进制数值，有三种类型：</p>

<ul>
	<li>可加性：可以按照与事实表关联的任意维度进行汇总；</li>
	<li>半可加性：只能按照特定维度汇总，对其他维度汇总时没有业务意义；</li>
	<li>不可加性：完全不具备可加性，比如比率型事实</li>
</ul>

<p>事实表有三种类型：</p>

<ul>
	<li>事务事实表

		<p>用来描述业务过程，跟踪空间或时间上某点的度量事件，保存的是最原子的数据，也称原子事实表；</p></li>
	<li>周期快照事实表

		<p>以具有规律性的、可预见的时间间隔记录事实；</p></li>
	<li>累积快照事实表

		<p>用来表述过程开始和结束之间的关键步骤事件，覆盖过程的整个生命周期，通常具有多个日期字段来记录关键时间点，当过程随着生命周期不断变化时，记录也会随着过程的变化而被修改。</p></li>
</ul>

<h3>事实表设计原则</h3>

<h4>尽可能包含所有与业务过程相关的事实</h4>

<p>事实表设计的目的是为了度量业务过程，因此分析哪些事实与业务过程有关是设计中非常重要的关注点，在事实表中应该尽量包含所有与业务过程相关的事实。</p>

<h4>只选择与业务过程相关的事实</h4>

<p>如下单这个业务过程，不应该存在支付金额这个表示支付业务过程的事实。</p>

<h4>分解不可加性事实为可加的组件</h4>

<p>对于不具备可加性条件的事实，需要分解为可加的组件。</p>

<p>如订单的优惠率，应该分解为订单原价金额和订单优惠金额两个事实存在事实表中。</p>

<h4>在选择维度和事实之前必须先声明粒度</h4>

<p>粒度用于确定事实表中一行所表示业务的细节层次，决定了维度模型的扩展性，在选择维度和事实之前必须先声明粒度，且每个维度和事实必须与所定义的粒度保持一致。</p>

<p>粒度定义越细越好，这样能提供最大限度的灵活性，支持无法预期的各种细节层次的用户需求。</p>

<h4>在同一个事实表中不能有多种不同粒度的事实</h4>

<p>事实表中所有事实需要与表定义的粒度保持一致，在同一个事实表中不能有多种不同粒度的事实。</p>

<h4>事实的单位要保持一致</h4>

<p>对于同一个事实表中事实的单位，应该采用一致的计量单位。</p>

<h4>对事实的null值要处理</h4>

<p>方便数据在数据库中计算处理。</p>

<h4>使用退化维度提供事实表的易用性</h4>

<p>维度属性也可以存储到事实表中，这种存储到事实表中的维度称为<strong>退化维度</strong>。可以减少下游用户使用时关联多个表的操作，通过增加冗余存储的方式减少计算开销，提高使用效率。</p>

<h3>事实表设计方法</h3>

<ol>
	<li>选择业务过程及确定事实表类型

		<p>明确业务需求之后，需要进行详细的需求分析，对业务的整个生命周期进行分析，明确关键的业务步骤，从而选择与需求有关的业务过程。</p>

		<p>选择了业务过程之后，相应的事实表类型也随之确定了。比如选择了单一业务过程，事实表类型就是单事务事实表；选择多个业务过程，并且需要分析各个业务过程之间的时间间隔，那么所建立的事实表应为包含了所有业务过程的累积快照事实表；</p></li>
	<li>声明粒度

		<p>粒度的声明意味着精确定义事实表的每一行所表示的业务含义，粒度传递的是与事实表度量有关的细节层次。明确的粒度能确保对事实表中行的意思的理解不会产生混淆，保证所有的事实按照同样的细节层次记录；</p></li>
	<li>确定维度

		<p>完成粒度声明以后，也就意味着确定了主键，对应的维度组合以及相关的维度字段就可以确定了，应该选择能够描述清楚业务过程所处的环境的维度信息；</p></li>
	<li>确定事实

		<p>事实可以通过回答“过程的度量是什么”来确定。应该选择与业务过程有关的所有事实，且事实的粒度要与所声明的事实表的粒度一致；</p></li>
	<li>冗余维度

		<p>传统维度建模的星型模型一般将维度存放在维度表中，来减少事实表的维度冗余。而在大数据的事实表模型设计中，一般事实表会冗余方便下游用户使用的常用维度。</p></li>
</ol>

<hr />

<h3>事务事实表</h3>

<h5>设计过程</h5>

<p>任何类型的事件都可以被理解为一种事务。</p>

<p>事务事实表，即针对这些过程构建的一类事实表，用以跟踪定义业务过程的个体行为，提供丰富的分析能力，作为数据仓库原子的明细数据。</p>

<p>具体过程同上文<strong> 事实表设计方法</strong>。</p>

<h5>单事务事实表</h5>

<p>针对每个业务过程设计一个事实表。方便针对每个业务过程进行独立的分析研究。</p>

<h5>多事务事实表</h5>

<p>将不同的事实放在同一个事实表中，即同一个事实表包含不同的业务过程。</p>

<p>事实的处理有两种方法：</p>

<ul>
	<li>不同业务过程的事实使用不同的事实字段进行存放</li>
	<li>不同业务过程的事实使用同一个事实字段进行存放，但增加一个事实标签</li>
</ul>

<h5>两种事实表对比</h5>

<ol>
	<li>业务过程

		<p>多个业务过程是否放到同一个事实表中，首先需要分析不同业务过程之间的相似性和业务源系统。</p></li>
	<li>粒度和维度

		<p>当不同业务过程的粒度相同，同时拥有相似的维度，就可以考虑采用多事务事实表。粒度不同，必定是不同的事实表。</p></li>
	<li>事实

		<p>如果单一业务过程的事实较多，同时不同业务过程的事实又不相同，则可以考虑使用单事务事实表</p></li>
	<li>下游业务使用

		<p>单事务事实表对于下游用户而言更容易理解，关注那个业务过程就使用相应的事务事实表</p></li>
	<li>计算存储成本

		<p>当业务过程数据来源于同一个业务系统，具有相同的粒度和维度，且维度较多而事实相对不多时，可以考虑多事务事实表</p></li>
</ol>

<h5>父子事实的处理方式</h5>

<p>面对父订单对应多笔子订单的情况，按照最细粒度原则，事务事实表会选择子订单粒度。通过分摊父订单的金额将所有业务过程的度量全部带进事务事实表中。</p>

<h5>事实的设计准则</h5>

<ul>
	<li>事实完整性

		<p>事实表包含与其描述的过程有关的所有事实，即尽可能多的获取所有的度量。</p></li>
	<li>事实一致性

		<p>在确定事务事实表的事实时，明确存储每一个事实以确保度量的一致性。</p></li>
	<li>事实可加性

		<p>事务事实表中关注更多的是可加性事实</p></li>
</ul>

<hr />

<h3>周期快照事实表</h3>

</body>
</html>

