<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>维度设计</title>
	</head>
<body>
<h1>维度设计</h1>

<hr />

<h2>维度设计基础</h2>

<h3>维度的基本概念</h3>

<blockquote>
<p><strong>在维度建模中，将度量称为“事实”，将环境描述为“维度”，维度是用于分析事实所需要的多样环境</strong>。例如，在分析交易过程时，可以通过买家、卖家、商品和时间等维度描述交易发生的环境。</p>
</blockquote>

<p><strong>维度所包含的表示维度的列，成为维度属性。维度属性是查询约束条件、分组和报表标签生成的基本来源，是数据易用性的关键</strong>。例如，在查询请求中，获取某类目的商品是通过约束商品维度的类目属性来实现的。</p>

<p>维度使用主键标识其唯一性，主键也是确保与之相连的任何事实表之间存在引用完整性的基础。主键有两种：<strong>代理键</strong>和<strong>自然键</strong>，它们都是用于标识某维度的具体值。<strong>代理键</strong>不具有业务含义，一般用于处理缓慢变化维度。<strong>自然键</strong>具有业务含义。例如，商品维表的每一行可以生成一个唯一的代理键与之对应；商品本身的自然键可能是商品ID。</p>

<h3>维度的基本设计方法</h3>

<blockquote>
<p>维度的设计过程就是确定维度属性的过程。如何生成维度属性，以及所生成的维度属性的优劣，是数仓易用性的关键。数仓的能力直接与维度属性的质量和深度成正比。</p>
</blockquote>

<ol>
	<li>选择维度或新建维度

		<p>作为维度建模的核心，在企业级数仓中必须保证维度的唯一性；</p></li>
	<li>确定主维表

		<p>此处的主维表一般是ODS表，直接与业务系统同步。如商品表直接与前台商品中心系统同步；</p></li>
	<li>确定相关维表

		<p>数仓是业务源系统的数据整合，不同业务系统或者同一业务系统中的表之间存在关联性。根据对业务的梳理，确定哪些表和主维表存在关联关系，并选择其中的某些表用于生成维度属性。如商品维度根据对业务逻辑的梳理，可以得到商品与类目、SPU、卖家、店铺等维度存在关联关系；</p></li>
	<li>确定维度属性

		<ul>
			<li>从主维表中选择维度属性或生成新的维度属性</li>
			<li>从相关维表中选择维度属性或生成新的维度属性</li>
		</ul></li>
</ol>

<p>确定维度属性的几点提示：</p>

<ul>
	<li>尽可能生成丰富的维度属性</li>
	<li>尽可能多地给出包括一些富有意义的文字性描述</li>
	<li>区分数值型属性和事实：数值型字段是作为事实还是维度属性，可以参考字段的一般用途。<strong>维度属性</strong>一般用于查询约束条件或分组统计；<strong>事实</strong>一般用于参与度量的计算。</li>
	<li>尽量沉淀出通用的维度属性：有些维度属性获取较困难，因此可以将尽可能多的通用的维度属性进行沉淀。既可以提高下游使用的方便性，又可以避免下游使用解析时由于各自逻辑不同而导致口径不一致。</li>
</ul>

<h3>维度的层次结构</h3>

<p>维度中的一些描述属性以层次方式或一对多的方式相互关联，可以被理解为包含主从关系的属性层次。</p>

<p>层次的最底层代表维度中描述最低级别的详细信息，最高层代表最高级别的概要信息。</p>

<p><strong>在属性的层次结构中进行钻取是数据钻取的方法之一</strong>。通过向报表中添加连续的维度细节级别，实现在层次结构中进行钻取。</p>

<p>假设有一笔交易事实表中的交易订单记录，沿着层次向下钻取，添加行业，得到行业实例个数的记录数；继续沿着层次向下钻取，添加一级类目，得到一级类目实例个数的记录数。</p>

<h3>规范化和反规范化</h3>

<p>当属性层次被实例化为一系列维度，而不是单一的维度时，被称为雪花模式。大多数OLTP的底层数据结构在设计时采用此种规范化技术，通过规范化处理将重复属性移至其自身所属的表中，删除冗余数据。</p>

<p>以商品维度举例，如果采用雪花模型进行规范化处理，数据表将表现为：</p>

<figure><img src="/Users/xerxes/note/dataWareHouse/src/%E8%A7%84%E8%8C%83%E5%8C%96%E5%A4%84%E7%90%86%E5%95%86%E5%93%81%E7%BB%B4%E5%BA%A6%E8%A1%A8%E7%8E%B0%E7%9A%84%E5%BD%A2%E5%BC%8F.jpg"/></figure>

<p>将维度的属性层次合并到单个维度中的操作称为反规范化。分析系统的主要目的是用于数据分析和统计，如何更方便用户进行统计分析决定了分析系统的优劣。</p>

<p>采用雪花模式，用户在统计分析的过程中需要大量的关联操作，使用复杂度高、查询性能差；而采用反规范化处理则方便、易用且性能好。</p>

<p>以商品维度举例，如果采用反规范化处理，数据表将表现为：</p>

<figure><img src="/Users/xerxes/note/dataWareHouse/src/%E5%8F%8D%E8%A7%84%E8%8C%83%E5%8C%96%E5%A4%84%E7%90%86%E5%95%86%E5%93%81%E7%BB%B4%E5%BA%A6%E8%A1%A8%E7%8E%B0%E7%9A%84%E5%BD%A2%E5%BC%8F.jpg"/></figure>

<p>反规范化处理从用户角度简化了模型，从分析角度降低了复杂性。</p>

<h3>一致性维度和交叉探查</h3>

<p>构建数仓不可能一蹴而就，一般采用迭代式的构建过程。而单独构建存在的问题是形成独立型数据集市，导致严重的不一致性。Kimball的<strong>数据仓库总线架构提供了一种分解企业级数据仓库规划任务的合理方法，通过构建企业范围内一致性维度和事实来构建总线架构</strong>。</p>

<p><strong>数据仓库总线架构的重要基石之一就是一致性维度</strong>。</p>

<p>在针对不同数据域进行迭代构建或并行构建时，存在很多需求是对于不同数据域的业务过程或者同一数据域的不同业务过程合并在一起观察。不同数据域的事实合并在一起进行数据探查，称为<strong>交叉探查</strong>。</p>

<p>如果不同数据域的计算过程使用的维度不一致，就会导致交叉探查存在问题。当存在重复的维度，但维度属性或维度属性的值不一致时，会导致交叉探查无法进行或交叉探查结果错误。</p>

<p>维度一致性的几种表现形式：</p>

<ul>
	<li>共享维表：比如商品、卖家、类目等维度有且只有一个；</li>
	<li>一致性上卷：其中一个维度的维度属性是另一个维度的维度属性的子集，且两个维度的公共维度属性结构和内容相同；</li>
	<li>交叉属性：两个维度具有部分相同的维度属性</li>
</ul>

<hr />

<h3>维度设计高级主题</h3>

<h5>维度整合</h5>

<p>数仓的重要数据来源是大量的、分散的面向应用的操作型环境。</p>

<p>不同的应用在设计过程中，主要满足本应用的需求，很少会考虑和其他系统进行数据集成。</p>

<p>应用之间的差异具体表现在：</p>

<ul>
	<li>编码、命名习惯、度量单位等方面</li>
	<li>应用出于性能和扩展性的考虑，或者随技术架构的演变，以及业务的发展，采用不同的物理实现</li>
</ul>

<p>所以数据由面向应用的操作型环境进入数仓后，需要进行数据集成。将面向应用的数据转换为面向主题的数仓数据，本身就是一种即成。具体体现在如下几个方面：</p>

<ul>
	<li>命名规范的统一</li>
	<li>字段类型的统一</li>
	<li>公共代码及代码值的统一</li>
	<li>业务含义相同的表的统一：主要依据高内聚、低耦合的理念，在物理实现中，将业务关系大、源系统影响差异小的表进行整合；将业务关系小、源系统影响差异大的表进行分而治之。通常有如下几种集成方式：

		<ul>
			<li>采用主从表的设计方式，将两个表或多个表都有的字段放在主表中，从属信息分别放在各自的从表中</li>
			<li>直接合并，共有信息和个性信息都放在同一个表中</li>
			<li>不合并，因为源表的表结构及主键等差异很大，无法合并，使用数仓里的多个表存放各自的数据</li>
		</ul></li>
</ul>

<p>表级别的整合有两种表现形式：</p>

<ol>
	<li>垂直整合

		<p>不同来源表包含相同的数据集，只是存储的信息不同</p></li>
	<li>水平整合

		<p>不同来源表包含不同的数据集，不同子集之间无交叉，也可以存在部分交叉。</p></li>
</ol>

<h5>水平拆分</h5>

<p>维度通常可以按照类别或类型进行细分。设计维度主要有两种解决方案，一是将维度的不同分类实例化为不同的维度，同时在主维表中保存公共属性；二是维护单一维度，包含所有可能的属性。在设计过程中需要重点考虑三个原则：</p>

<ul>
	<li>扩展性

		<p>当源系统、业务逻辑变化时，能通过较少的成本快速扩展模型，保持核心模型的相对稳定性，做到高内聚、低耦合</p></li>
	<li>效能

		<p>在性能和成本方面取得平衡，通过牺牲一定的存储成本，达到性能和逻辑的优化</p></li>
	<li>易用性

		<p>模型可理解性高、访问复杂度低。用户能够方便地从模型中找到对应的数据表，并能够方便地查询和分析</p></li>
</ul>

<p>根据数据模型设计思想，在对维度进行水平拆分时，主要考虑两个依据：</p>

<ol>
	<li>维度的不同分类的属性差异情况。当维度属性随类型变化较大时，将所有可能的属性建立在一个表中是不切合实际的。</li>
	<li>业务的关联程度。两个相关性较低的业务，耦合在一起弊大于利，对模型的稳定性和易用性影响较大。</li>
</ol>

<hr />

<h3>维度变化</h3>

<h5>缓慢变化维</h5>

<blockquote>
<p>缓慢变化维度（Slowly Changing Dimensions）的提出是因为在现实生活中，维度的属性并不是静态的，它会随着时间的流逝发生缓慢的变化。这种随时间发生变化的维度一般称为缓慢变化维度。</p>
</blockquote>

<p>如何处理SCD问题</p>

<ol>
	<li>保留原始值

		<p>此类型维度属性值绝不会变化，所以事实始终按照该原始值分组</p></li>
	<li>重写

		<p>对其相应需要重写维度行中的旧值，以当前值替换。因此其始终反映最近的情况</p></li>
	<li>增加新行

		<p>数据仓库系统的目标之一是正确的表示历史。当提及缓慢变化维度属性时，增加新行就是主要应用于支持这一需求的技术。这一类方法典型代表就是拉链表。</p></li>
	<li>增加新属性

		<p>上一种方法能够区分历史情况，但无法保证能够将新属性值和过去的历史事实关联，反之亦然。</p>

		<p>这类方法适合需要根据先后顺序来得出某种结论的场景。优点是可以同时分析当前及前一次变化的属性值，缺点是只保留了最后一次变化信息。</p>

		<p>这类方法在一些场景中是可以解决很多问题的，但是不能无限制地添加新的字段来记录历史的状态，因此在使用时要有所取舍。</p></li>
</ol>

<h5>快照维表</h5>

<p>基于数仓的计算周期，每个周期保留一份全量快照数据。这样任意一天的事实都可以获取到当天的维度信息，也可以获取到最新的维度信息，通过限定日期，采用自然键进行关联即可。</p>

<p>优点：</p>

<ul>
	<li>简单有效，开发和维护成本低</li>
	<li>使用方便，理解性好</li>
</ul>

<p>缺点：</p>

<ul>
	<li>存储的极大浪费</li>
</ul>

<h5>极限存储</h5>

<p>历史拉链存储是指利用维度模型缓慢变化维度的第二种处理方式。通过新增两个时间戳字段将所有以天为粒度的变更数据记录下来。</p>

<p>但是这种存储方式对于下游使用方式存在一定的理解障碍，另外以<code>start_date</code>和<code>end_date</code>做分区，随着时间推移，分区数量会极度膨胀。为解决这两个问题，阿里提出采用极限存储的方式来处理。</p>

<ol>
	<li>透明化

		<p>底层的数据还是历史拉链存储，但是上层做一个视图操作或者在hive里做一个hook，通过分析语句的语法树，把对极限存储前的表的查询转换成对极限存储表的查询</p></li>
	<li>分月做历史拉链表

		<p>假设对<code>start_date</code>和<code>end_date</code>做分区并且不做限制，那么一年最多可能产生的分区数是：365*364/2个。</p>

		<p>如果在每月月初重新开始做历史拉链表，那么一年最多可能产生的分区数是：12*(1+(30+29)/2)个。采用极限存储的处理方式，极大地压缩了全量存储的成本。</p></li>
</ol>

<h5>微型维度</h5>

<p>采用极限存储，需要避免维度的过度增长。通过将一些属性从维表中移出，放置到全新的维表中，可以解决维度的过度增长。</p>

<p>微型维度的创建是通过将一部分不稳定的属性从主维度中移出，并将它们放置到拥有自己代理键的新表中。这些属性之间没有直接关联，因此没有自然键。通过为每个组合创建新行的一次性过程来加载数据。</p>

<hr />

<h3>特殊维度</h3>

<h5>递归层次</h5>

<p>维度属性以层次方式或一对多的方式相互关联；或者描述为不同维度之间的主从关系，比如商品和类目的关系、商品和品牌的关系。</p>

<p>维度的递归层次，按照层次是否固定分为<strong>均衡层次结构</strong>和<strong>非均衡层次结构</strong>。</p>

<p>在递归层次中进行上钻和下钻是很常见的，为方便处理可以在维度模型中，对此层次结构进行处理。</p>

<ol>
	<li>层次结构扁平化

		<p>降低递归层次使用复杂度的最简单有效的方法是<strong>层次结构的扁平化</strong>，通过建立维度的固定数量级别的属性来实现，可以在一定程度上解决上钻和下钻的问题。对于均衡层次结构，采用扁平化最有效。</p>

		<table border=1>
		<td>类目ID</td>
		<td>类目级别</td>
		<td>是否叶子结点</td>
		<td>一级类目</td>
		<td>二级类目</td>
		<td>三级类目</td>
		</table></li>
	<li>层次桥接表

		<p>该方法适合解决更宽泛的分析问题，灵活性高，较复杂，使用成本高。</p>

		<p>桥接表存储父类目ID、子类目ID和类目层级间隔。</p>

		<p>以下钻操作为例，限制类目表的类目ID为x，通过类目ID和类目桥接表的父类目ID关联；通过类目桥接表的子类目ID和交易事实表的类目ID关联；即可针对事实表进行下钻操作。</p></li>
</ol>

<h5>行为维度</h5>

<p>有很多维度需要通过计算得出，并且都和事实相关，称之为<strong>行为维度</strong>，也称<strong>事实衍生的维度</strong>。</p>

<p>按照加工方式可分为几类：</p>

<ul>
	<li>另一个维度的过去行为：如买家最近一次交易时间</li>
	<li>快照事实行为维度：如买家从年初截止当前的交易额</li>
	<li>分组事实行为维度：将数值型事实转换为枚举值，如按照金额划分等级</li>
	<li>复杂逻辑事实行为维度：通过复杂算法加工或多个事实综合加工得到</li>
</ul>

<p>对于行为维度，有两种处理方式：</p>

<ul>
	<li>将其冗余至现有的维度表中</li>
	<li>加工成单独的行为维表</li>
</ul>

<p>具体采用哪种方式参考以下原则：</p>

<ul>
	<li>避免维度过快增长</li>
	<li>避免耦合度过高</li>
</ul>

<h5>多值维表</h5>

<p>对于事实表的一条记录在某维度表中有多条记录与之对应的情况，常用处理方式有三种：</p>

<ul>
	<li>降低事实表的粒度</li>
	<li>采用多字段</li>
	<li>采用较为通用的桥接表：通过在事实表和维度表之间开发一个分组表，通过此分组表建立连接。</li>
</ul>

<h5>多值属性</h5>

<p>维度表中的某个属性字段同时有多个值，称之为“多值属性”。对于多值属性。常用处理方式有三种：</p>

<ul>
	<li>保持维度主键不变，将多值属性放在维度的一个属性字段中</li>
	<li>保持维度主键不变，将多值属性放在维度的多个属性字段中</li>
	<li>维度主键变化，一个维度值存放多条记录</li>
</ul>

<h5>杂项维度</h5>

<p>杂项维度是由操作型系统中的指示符或者标志字段组合而成的，一般不在一致性维度之列。如交易类型、支付状态等，它们在源系统中直接保存在交易表中。</p>

<p>通常可以建立杂项维度，将这些字段建立到一个维度表中，在事实表中只需保存一个外键即可。多个字段的不同取值组成一条记录，生成代理键，存入维度表。</p>

</body>
</html>

