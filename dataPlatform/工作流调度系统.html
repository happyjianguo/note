<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>工作流调度系统</title>
	</head>
<body>
<h1>工作流调度系统</h1>

<hr />

<h3>调度系统类别</h3>

<p>一个成熟易用、便于管理和维护的作业调度系统，需要和大量的周边组件对接，不仅包括各种存储计算框架，还可能要处理或使用到血缘管理、权限控制、负载流控、监控报警、质量分析等各种服务或事务。</p>

<p>根据实际的功能定位，市面上的作业调度系统主要分为两大类：<em>定时分片类作业调度系统</em>和 <em>DAG 工作流类作业调度系统</em>。</p>

<h5>定时分片类作业调度系统</h5>

<blockquote>
<p>这种功能定位的作业调度系统，其最早的需求来源和出发点往往是做一个分布式 Crontab 和 Quartz。</p>
</blockquote>

<p>这类系统的核心目标基本是以下两点。</p>

<ol>
	<li>对作业分片逻辑的支持

		<p>将一个大的任务拆成多个小任务，分配到不同的服务器上执行， 难点在于要做到不漏、不重，保证负载均衡，节点崩溃时自动进行任务迁移等</p></li>
	<li>高可用的精确定时触发要求

		<p>因为往往涉及实际业务流程的及时性和准确性，所以通常需要保证任务触发的强实时和可靠性。</p></li>
</ol>

<p>负载均衡、弹性扩容、状态同步和失效转移通常是这类调度系统在架构设计时重点考虑的特性。</p>

<h5>DAG工作流类调度系统</h5>

<blockquote>
<p>DAG工作流类调度系统的关注重点，则定位于任务的调度依赖关系的正确处理，分片执行的逻辑通常不是系统关注的核心，或者不是系统核心流程的关键组成部分，如果某些任务真的关注分片逻辑，往往交给后端集群（比如MR任务自带分片能力）或具体类型的任务执行后端去实现 。</p>
</blockquote>

<p>DAG工作流类调度系统关注的重点通常包括以下几点。</p>

<ol>
	<li>足够丰富和灵活的依赖触发机制

		<p>比如时间触发任务、依赖触发任务、混合触发任务。而依赖触发任务自身可能还要考虑多亲依赖、长短周期依赖（如小时任务依赖天任务，或者反过来）、依赖范围判定（比如所依赖任务最后一次成功就可以触发下游，还是过去一个星期的所有任务都成功才可 以触发下游〉、自身历史任务依赖、串并行触发机制等。</p></li>
	<li>作业的计划、变更和执行流水的管理和同步

		<p>定时分片类调度系统中固然也要考虑这个需求，但通常相对简单。而在DAG 工作流类调度系统中，因为任务触发机制的灵活性和作业依赖关系的复杂性，这个需求就尤为重要，需要提供的功能更加复杂，具体的问题解决起来也困难很多。</p></li>
	<li>任务的优先级管理、业务隔离、权限管理等。

		<p>在定时分片类调度系统中，具体执行端的业务在很多情况下本来就是隔离的，注册了特定业务的节点才会去执行特定的任务。而且业务链路一般都比较短，再加上强实时性要求，所以对优先级的管理通常要求也不高，基本靠资源隔离来实现资源的可用，一般不存在竞争资源的问题，权限管理也是一样的。而在 DAG 工作流类调度系统中，往往一大批作业共享资源执行，所以优先级、负载隔离和权限管控的问题也就突显出来了。</p></li>
	<li>各种特殊流程的处理，比如暂停任务、重刷历史数据、人工标注失败或成功、临时任务和周期任务的协同等。

		<p>这类需求本质上也是业务流程的复杂性带来的，比如业务逻辑变更、脚本写错、上游数据有问题、下游系统挂掉等，而业务之间的网状关联性，导致处理问题时需要考虑的因素很多，也就要求处理的手段应足够灵活强大。</p></li>
	<li>完备的监控报警通知机制。

		<p>最简单的有任务失败报警、超时报警，复杂一点的有流量负载监控、业务进度监控和预测，如果做得再完善一点 ，还可以包括业务健康度监控分析、性能优化建议和问题诊断专家系统等。</p></li>
</ol>

<hr />

<h3>工作流调度系统的两种心法流派</h3>

<blockquote>
<p>DAG工作流调度系统有很多开源实现，这些系统从开发语言、支持的任务类型、调度方式、监控报警，到业务接入的方式、周边管理工具的完备性等角度来说，都是千差万别的。这些差别在很大程度上都是具体产品形态实现细节上的差异，但是其中之一是心法流派的差异，它在很大程度上影响了一个工作流调度系统的<em>核心设计思想</em>。这个差异就是:一个具体任务的执行，是依托一个<em>静态执行列表</em>，还是依托一个<em>动态执行列表</em>。</p>
</blockquote>

<p>要谈执行列表的心法流派问题，首先应明确<em>作业计划</em>和<em>任务实例</em>这两个概念。</p>

<p>通常情况下，既然你把一个作业放到调度系统上去监管执行，除了个别一次性作业，多数情况下这些作业都是需要周期性重复执行的 。 不同的是，有些作业是纯粹由时间驱动的，有些作业需要根据前置依赖任务的执行结果来触发执行 。</p>

<ol>
	<li>那么什么时候执行这个作业，是每个月月底执行一次；还是每天凌晨两点执行一次：又或者是早上 9 点到晚上 6 点之间，每个小时执行一次？任务触发的条件是前置任务全部成功，还是任一前置任务成功，又或者是自身的上一次执行结果也要成功？能够回答这些问题的就是所谓的作业计划。</li>
	<li>而具体到某年某月某天，一个作业什么时候真正执行一次？这一次具体的执行任务就是所谓的任务执行实例。</li>
</ol>

<p>所谓的<em>静态执行列表</em>流派，是指一个作业的具体执行实例，是根据作业计划提前计算并生成执行列表，且调度系统按照这个提前生成的执行列表去执行任务。有些调度系统实现，实际上就没有区分作业计划和任务执行列表，两者是合二为一的，依靠人工定义一个确定了依赖关系的任务列表，并定期执行整个列表 。</p>

<p>对于实际有作业计划和执行列表之分的系统，常见的做法是在前一天晚上接近凌晨的时候，分析所有作业的时间要求和作业间的依赖关系，并生成之后一天所有需要执行的作业的实例列表 ，将每个具体任务实例的执行时间点和相互依赖关系固化下来。调度系统执行任务时，遍历检查这个列表，触发满足条件的任务的执行。</p>

<p>所谓的<em>动态执行列表</em>流派，是指某个作业的具体执行实例，并没有提前固化计算出来，而是在它的上游任务 （纯时间周期任务就是上一个周期的任务）执行完毕时，根据当前时间点最新的作业计划和依赖关系动态计算出来的。</p>

<h5>为什么要分两种</h5>

<p>从周期性作业管理的角度来说，你面向的对象是<em>作业计划</em>。而调度系统面向的是<em>执行实例</em>。当计划产生变更时，就涉及作业计划列表之间的同步问题。</p>

<p>静态执行列表方案擅长处理时间范围确定的，最好是当前周期己知的一次性任务变更，前提是你对如何 Hack 执行列表有清楚的认识 。</p>

<p>而动态执行列表方案擅长处理尚未发生的长期计划变更，对于不等周期和短周期任务的变更，时效性也会好很多， 临时的一次性变更则需要通过其他方式来辅助完成。</p>

<h5>如何选择</h5>

<p>静态执行列表方案的系统架构相对简单，系统运行逻辑相对清晰，容易分析问题，但是能处理的场景也比较有限。在业务场景比较简单、任务依赖容易理清的场景下，静态执行列表方案的系统维护代价会比较小。</p>

<p>动态执行列表方案能覆盖的场景范围更广，计划变更响应更及时，但是系统架构实现相对复杂，运行逻辑也更加复杂，牵扯的因素较多 ，有时候不容易理顺逻辑。</p>

<hr />

<h3>工作流调度系统功能特性详解</h3>

<h5>工作流的定义方式</h5>

<ol>
	<li>静态显式定义和管理工作流

		<p>用户需要定义一个具体的作业流程里面都包含哪些作业，以及它们的依赖关系。</p>

		<p>对外部系统的关联和依赖较小，是一个相对独立封闭的环境，演进起来比较自由。</p>

		<p>周边的运维使用工具缺乏，易用性差，维护成本高。</p></li>
	<li>动态隐式定义和管理工作流

		<p>这些系统的管理维度是作业，用户定义的是作业之间的依赖关系，不需要定义哪些作业构成一个工作流。系统负责按规则将所有满足条件的任务调度起来，整个系统所有作业就是一个多斤多处并发执行的大工作流。</p></li>
</ol>

<h5>作业运行周期的管理</h5>

<p>显式静态定义工作流的系统，对作业运行周期的管理，通常都是以整个工作流为单位来定义和管理的 。 当调度时间到了时，启动整个工作流，工作流内部的作业按照依赖关系依次执行 。 所以如果一个工作流内部存在需要按不同周期进行调度的作业 ， 就会很难处理，需要利用各种补救手段去间接规避，比如拆分工作流、创建子工作流、复制多份作业等。</p>

<p>非显式动态定义工作流的系统，对作业运行周期的管理，通常是以单个作业为单位的，因为根本就没有固定的 Flow 这个单位可以管理，所以用户只需要按需定义自己作业的运行周期就好了 。 相对的，对调度系统开发者来说，实现的难度会比较大，因为正确地自动判定依赖触发关系的逻辑会比较复杂。</p>

<h5>作业依赖关系的管理</h5>

<p>对于采用人工显式定义工作流的系统而言 ，在很大程度上，作业依赖的管理其实是通过对工作流的拓扑逻辑的管理来实现的，用户改变工作流的拓扑逻辑的过程，实际上也改变了作业间的依赖关系。而作业的任务依赖关系，其边界基本上就是在当前的工作流范围之内。</p>

<p>对于非显式定义工作流的系统而言 ，用户直接管理作业的依赖，所以这类系统一般都会提供给用户配置上游任务和触发条件的接口／界面。用户通过改变作业之间的依赖关系，间接影响关联作业的运行流程拓扑逻辑 。</p>

<h5>作业异常管理和系统监控</h5>

<p>任务中间的脚本逻辑有错如何重跑自身和后续任务？任务失败如何跳过？任务失败如何重试？什么条件下重试？任务失败如何告警？什么方式告警？什么情况下停止告警？</p>

<h5>资源和权限控制</h5>

<p>任务太多，资源有限，如何定义优先级？如何给不同类型的任务分配资源？</p>

<p>谁能编辑、运行、管理一个任务？用户角色怎么定义？和周边系统的权限管理体系如何对接配合？</p>

<h5>系统运维能力</h5>

<p>是否有系统自身状态指标的监控，是否有业务操作日志，执行流水等便于分析排查问题。</p>

<hr />

</body>
</html>

