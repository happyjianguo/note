<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>大数据平台监控告警系统</title>
	</head>
<body>
<h1>大数据平台监控告警系统</h1>

<figure><img src="/Users/xerxes/note/dataPlatform/src/%E6%95%B0%E6%8D%AE%E8%B4%A8%E9%87%8F.jpeg"/></figure>

<hr />

<h3>数据质量保障原则</h3>

<h5>完整性</h5>

<p>指数据的记录和信息是否完整，是否存在缺失的情况，包括记录的缺失和记录中某个字段信息的缺失。</p>

<p>完整性的监控多出现在日志级别的监控上，一般会在数据接入的时候来做数据完整性校验。</p>

<h5>准确性</h5>

<p>指数据中记录的信息和数据是否准确，是否存在异常或者错误的信息。</p>

<p>一般准确性的监控多集中在对业务结果数据的监控，比如每日活跃、收入等数据是否正常。</p>

<h5>一致性</h5>

<p>指同一指标在不同地方的结果是否一致。</p>

<p>数据不一致的情况，多出现在数据系统到达一定的复杂度后，同一指标会在多处进行计算，由于计算口径或者开发人员的不同，容易造成同一指标出现不同的结果。</p>

<h5>及时性</h5>

<p>保障数据能够及时产出，这样才能体现数据的价值。</p>

<p>这点在数据质量监控中可以体现在监控结果数据是否在指定时间点计算完成。</p>

<h5>合理性</h5>

<p>主要包括格式、类型、值域和业务规则的合理有效。</p>

<hr />

<h3>数据质量监控</h3>

<p>数据质量监控分为三类：</p>

<ol>
	<li>监控</li>
	<li>告警</li>
	<li>多数据源</li>
</ol>

<figure><img src="/Users/xerxes/note/dataPlatform/src/%E6%95%B0%E6%8D%AE%E8%B4%A8%E9%87%8F%E7%9B%91%E6%8E%A7.png" title="数据质量监控"/></figure>

<h5>监控</h5>

<ol>
	<li>日常监控

		<p>日常监控中最重要的一个就是数据落地检查，这是所有监控的一个基础，另外一些重要的日常监控如：</p>

		<ul>
			<li>数据落地监控</li>
			<li>数据掉0监控：实际扩展一下就是数据量阈值监控，少于某个量就告警</li>
			<li>重复数据监控：很多表一定要监控重复数据的，这点至关重要。</li>
			<li>关键指标监控</li>
			<li>数据同比环比监控</li>
		</ul>

		<p>这是一些常用的监控，可以做一个规则引擎，将这些监控做成规则，哪个表需要就配一下。</p></li>
	<li>数据对账

		<p>这点主要会体现到实时数据上，特别是Kafka数据落地，必须要有一个监控机制来知道我们的数据落地情况。当然离线数据同样需要数据对账，对账方法有很多，比如可以和业务库来对比。</p></li>
	<li>性能监控

		<p>数据可用性监控，也是一个很重要的点。主要监控点如：</p>

		<ul>
			<li>查询性能，比如es的某个索引，在不同时间段的查询响应速度，同理presto、hive、kylin这些的查询都需要注意一下，这点可以通过任务监控来观察。</li>
			<li>数据读写影响，机器故障影响，这点平常不太关注，不过像es这种，在写入数据的时候其实会影响读数据的，需要监控一下，并做相应调整。</li>
			<li>服务器状态</li>
		</ul></li>
</ol>

<h5>告警</h5>

<p>以邮件、短信等方式发出告警。如果有很多的告警，可以考虑做一个告警报表系统来展示，特别是数据量趋势这种监控内容，可视化的对比比较有效。</p>

<h5>多数据源</h5>

<p>在目前大数据场景下，各种开源组件引入的十分多，而且会有新的组件不停地引入，因此要考虑到对不同组件的数据监控。</p>

<hr />

<h3>怎样监控</h3>

<figure><img src="/Users/xerxes/note/dataPlatform/src/%E5%A6%82%E4%BD%95%E7%9B%91%E6%8E%A7.png"/></figure>

<h5>规则引擎</h5>

<p>定义各种告警规则，可能是一条sql，也可能是一些具体的算法。</p>

<p>比如数据延迟到达、数据同比环比、数据趋势、一些定制化算法</p>

<ol>
	<li>sql模版

		<p>大多数存储引擎中，都是通过sql来使用数据，这种数据可以通过一张存有sql模版的表来定义规则。</p></li>
	<li>元数据

		<p>很多数据库都是有元数据管理的，可以通过元数据抓取一些信息如表的数据量。但是这类信息满足的功能比较少，需要结合其他来使用。</p></li>
	<li>自定义模版

		<p>很多数据不是通过简单的sql来使用，而且有些存储系统不支持sql，这时就需要定制化的算法来实现。</p></li>
</ol>

<h5>执行引擎</h5>

<p>执行各种规则，同时要考虑各种数据源的差异。</p>

<ol>
	<li>sql执行

		<p>很多规则都是通过sql来执行的，提前配置好大部分的sql模版，然后需要监控哪张表就在这张表配置。具体执行可以考虑：</p>

		<ul>
			<li>合理的任务调度</li>
			<li>合理的替换执行引擎</li>
			<li>合理的任务依赖：比如数据到达之后才执行监控</li>
		</ul></li>
	<li>直接获取数据量

		<p>直接从存储系统的元数据中获取表的记录数，这些记录数可以直接用作数据量相关的监控</p></li>
	<li>算法执行引擎

		<p>因为定制化比较强，在设计时需要一个比较灵活的架构。</p></li>
	<li>多数据源

		<p>在规则引擎里面加一些区分，在执行时分开实现。</p></li>
</ol>

<h5>元数据系统</h5>

<p>数据质量监控本来也算是元数据系统的一部分，在配置表的告警信息时，要和元数据系统结合</p>

<hr />

<h3>关键流程</h3>

<ol>
	<li>质量需求：发现数据问题；信息提报、收集需求；检核规则的需求等；</li>
	<li>提炼规则：梳理规则指标、确定有效指标、检核指标准确度和衡量标准；</li>
	<li>规则库构建：检核对象配置、调度配置、规则配置、检核范围确认、检核标准确定等；</li>
	<li>执行检核：调度配置、调度执行、检核代码；</li>
	<li>问题检核：检核问题展示、分类、质量分析、质量严重等级分类等；</li>
	<li>分析报告：数据质量报告、质量问题趋势分析，影响度分析，解决方案达成共识；</li>
	<li>落实处理：方案落实执行、跟踪管理、解决方案Review及标准化提炼；</li>
	<li>知识库体系形成：知识经验总结、标准方案沉淀、知识库体系建设</li>
</ol>

<figure><img src="/Users/xerxes/note/dataPlatform/src/%E6%95%B0%E6%8D%AE%E8%B4%A8%E9%87%8FPDCA%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg"/></figure>

<hr />

<hr />

<hr />

<h3>阿里数据质量方法概述</h3>

<figure><img src="/Users/xerxes/note/dataPlatform/src/%E9%98%BF%E9%87%8C%E6%95%B0%E6%8D%AE%E8%B4%A8%E9%87%8F%E5%BB%BA%E8%AE%BE%E6%96%B9%E6%B3%95.jpg"/></figure>

<h5>消费场景知晓</h5>

<p>基于不断膨胀的数据和对数据类的应用，阿里内部提出了数据资产等级的方案，旨在解决消费场景知晓的问题。</p>

<ol>
	<li>数据资产等级定义

		<ul>
			<li>毁灭性质：数据一旦出错，将会引起重大资产损失</li>
			<li>全局性质：数据直接或间接用于集团级业务和效果的评估、重要平台的运维、对外数据产品的透露、影响用户在阿里系网站的行为</li>
			<li>局部性质：数据直接或间接用于内部一般数据产品或者运营/产品报告</li>
			<li>一般性质：数据主要用于日常数据分析，出现问题影响极小</li>
			<li>未知性质：不能明确说出数据的应用场景</li>
		</ul></li>
	<li>数据资产等级落地方法

		<p>借助元数据知道整个数据仓库中的哪些表服务于这个数据产品，通过给数据产品或者应用划分数据资产等级，依托元数据的上下游血缘关系，就可以将整个消费链路打上某一类数据资产的标签。</p></li>
</ol>

<h5>数据生产加工各个环节卡点校验</h5>

<ol>
	<li>在线系统卡点校验

		<p>指在在线业务系统的数据生成过程中进行的卡点校验。既要保证数据的准确性，也要保障和离线数据的一致性。</p>

		<p>数据准确性的保障主要以数据监控为主。</p>

		<p>为了保障在线数据和离线数据的一致性，同时需要工具和人工的配合。</p>

		<ul>
			<li>工具：首先是发布平台，在业务进行变更时，订阅这个发布过程，根据数据资产整理出哪些变更会影响数据的使用，然后给到离线开发人员，使其知晓这次变更内容；</li>
			<li>其次是数据库表的变化感知：无论是随着业务发展而做的数据库扩容还是表的DDL变化，都需要主动通知到离线开发人员</li>
		</ul></li>
	<li>离线系统卡点校验

		<p>如何保障数据在数仓中加工过程的质量，是离线数据仓库保障数据质量的重要环节。</p>

		<p>首先是代码提交时的卡点校验；</p>

		<p>其次是任务发布上线时的卡点校验，每次变更都需要线下完成测试后再发布到线上环境中，线上测试通过后才算发布成功。发布上线前的测试主要包括code review和回归测试，对于资产等级较高的任务变更发布，采取强阻塞的形式，必须通过彼岸完成回归测试之后才允许发布。</p></li>
</ol>

<h5>风险点监控</h5>

<p>这一部分主要是针对在数据日常运行过程中可能出现的数据质量和时效等问题进行监控，包括在线数据和离线数据的风险点监控两个方面。</p>

<ol>
	<li>在线数据风险点监控

		<p>在线业务系统的数据生产过程需要保证数据质量，主要根据业务规则对数据进行监控。</p></li>
	<li>离线数据风险点监控

		<p>主要包括对数据准确性和数据产出及时性的监控。</p>

		<ul>
			<li>数据及时性：为了确保每天的数据能够按时产出，需要进行一系列的报警和优先级设置。

				<ul>
					<li>任务优先级：调度平台需要确保重要任务获得高优先级</li>
					<li>任务报警：监控任务的实时运行情况，发现异常则执行不同等级的报警，根据不同的资产等级执行强保障或弱保障。</li>
					<li>阿里监控报警系统-摩萨德：根据离线任务的运行情况实时决策是否告警、何时告警、告警方式、告警给谁。</li>
				</ul></li>
		</ul></li>
</ol>

<h5>质量衡量</h5>

<ol>
	<li>数据质量起夜率

		<p>数仓的作业任务大多在凌晨进行，一旦数据出现问题就需要开发人员起夜进行处理。每个月的起夜次数是衡量数据质量建设完善度的一个关键指标。</p></li>
	<li>数据质量事件

		<p>针对每一个数据质量问题，都记录一个数据质量事件。事件首先用来跟进数据质量问题的处理过程；其次用来归纳分析数据质量原因；最后根据数据质量原因来查缺补漏，既要找到问题原因，也要针对类似问题给出后续预防方案。</p></li>
	<li>数据质量故障体系

		<p>严重的数据质量问题升级为故障。</p>

		<p>一旦出现故障，通过故障系统，要求相关团队第一时间跟紧解决问题，消除影响。</p>

		<ul>
			<li>故障定义：首先识别出重要的数据，注册到系统，填写相关的业务情况，将这部分数据的任务挂到平台基线上，一旦出现问题自动形成故障单</li>
			<li>故障等级：故障发生后，根据一定的标准判断故障等级</li>
			<li>故障处理：故障发生后，需要快速的识别故障原因，尽快将故障的处理进度通知到相关方，迅速解决，消除影响，尽可能减少对业务的影响</li>
			<li>故障review：分析故障的原因、处理过程的复盘、形成后续解决的action，形成记录，对故障的责任进行归属</li>
		</ul></li>
</ol>

<hr />

<hr />

<hr />

<h2>如何构建</h2>

<h3>方案一</h3>

<p>直接使用开源的大数据数据质量解决方案Apache Griffin</p>

<h3>方案二</h3>

<p>Data Source -&gt; Telegraf -&gt; InfluxDB -&gt; Grafana -&gt; Alerting</p>

<h3>方案三</h3>

<p><a href="https://cloud.tencent.com/developer/news/211680">https://cloud.tencent.com/developer/news/211680</a></p>

<h4>收集数据</h4>

<p><a href="https://www.tuicool.com/articles/A3AFvu6" title="Measure Anything，Measure Everything">https://www.tuicool.com/articles/A3AFvu6</a></p>

<p>企业级的监控数据，通常包括如下三类：</p>

<ul>
	<li>网络数据：包括骨干交换机，核心交换机等硬件设备；</li>
	<li>服务器数据：包括服务器的 CPU、内存、硬盘的各项使用数据；</li>
	<li>应用数据：在应用数据这一块，有一个开源项目叫 Statsd，它催生了“应用数据收集标准” </li>
</ul>

<h4>存储数据（时间序列的存储）</h4>

<p>监控报警的数据，全部都是围绕“监控指标的值随时间变化的趋势”这一目标而设计的。每一项监控指标数据序列都是天然的按“时间排序”的，这是其特点。</p>

<h4>报警规则</h4>

<p>按什么规则报警，显然是和每个公司的具体业务绑定的。而规则是基于对历史数据的分析、度量。这牵扯到公司业务的个性化。</p>

<h5>报警规则定义</h5>

<h6>基于“规则表达式”</h6>

<p>在熟悉了表达式语言后，比较容易编写，但灵活性差。在实现复杂的报警规则时比较难，一般适用于简单的报警规则。</p>

<h6>基于直接“脚本&amp;编程”</h6>

<p>这种类型的规则定义，提供了无限的灵活性。因为“可编程”，就等于可以“do everything”。</p>

<p>但也有一些坏处，比如：又多引入了一个外部依赖：代码管理库，且意味着又要为另一套系统做高可用 HA，一般为公司内部的代码管理使用 Github／Gitlab。</p>

<p>想快速修改报警规则时，流程会相对慢，因为要经过代码的修改，Merge，最后 Submit。</p>

<h6>基于可视化配置规则</h6>

<p>比如 Zabbix 的 Trigger 配置。</p>

<p>Grafana 在 4.0 之后，也有了基于规则的简单报警功能：Alerting Engine &amp; Rules Guide。</p>

<h4>报警行为</h4>

</body>
</html>

