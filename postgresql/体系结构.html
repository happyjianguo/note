<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>体系结构</title>
	</head>
<body>
<h1>体系结构</h1>

<blockquote>
<p>pg数据库由连接管理系统（系统控制器）、编译执行系统、存储管理系统、事务系统、系统表五大部分组成。</p>
</blockquote>

<p>连接管理系统接收外部操作对系统的请求，对操作请求进行预处理和分发，起系统逻辑控制作用；</p>

<p>编译执行系统由查询编译器、查询执行器组成，完成操作请求在数据库中的分析处理和转化工作，最终实现物理存储介质中数据的操作；</p>

<p>存储管理系统由索引管理器、内存管理器、外存管理器组成，负责存储和管理物理数据，提供对编译查询系统的支持；</p>

<p>事务系统由事务管理器、日志管理器、并发控制、锁管理器组成，日志管理器和事务管理器完成对操作请求处理的事务一致性支持，锁管理器和并发控制提供对并发访问数据的一致性支持；</p>

<p>系统表是pg数据库的元信息管理中心，包括数据库对象和数据库管理控制信息，系统表管理元数据信息，将pg数据库的各个模块有机地连接在一起，形成一个高效的数据管理系统。</p>

<hr />

<h3>系统表</h3>

<p>系统表是pg数据库存放结构元数据的地方。pg的每一个数据库都有自己的一套系统表，其中大多数系统表都是在数据库创建时从模版数据库中拷贝来的，少数系统表是所有数据库共享的。</p>

<p>由于系统表保存了数据库的所有元数据，所以系统运行时对系统表的访问非常频繁，因此在内存中建立了共享的系统表CACHE，使用Hash函数和Hash表提高查询效率。</p>

<h5>主要系统表功能及依赖关系</h5>

<ol>
	<li><code>pg_namespace</code>

		<p>用于存储命名空间。<code>pg_namespace</code>中每一个元组对应一个名字空间，名字空间层次是：数据库、模式表、属性。当要访问一个对象时，pg会按：特殊名字空间、临时表名字空间、系统表的名字空间顺序进行搜索。每一个名字空间有一个OID：对象标识符，用于在整个数据库系统唯一标识一个数据库对象。</p></li>
	<li><code>pg_tablespace</code>

		<p>存储表空间信息。所有数据库共享一个表空间。</p>

		<p>pg里的表空间允许在文件系统里定义代表数据库对象的文件的存放位置，可以通过表空间控制一个pg中数据的磁盘布局，从而将pg系统的数据分布在不同的磁盘位置。</p></li>
	<li><code>pg_database</code>

		<p>存放了当前数据集簇中数据库的信息，是所有数据库共享的系统表，每一个数据库分配一个OID。</p></li>
	<li><code>pg_class</code>

		<p>存储表及与表类似结构的数据库对象信息，包含索引、序列、视图、复合数据类型、TOAST表等。每一个对象分配一个OID。</p></li>
	<li><code>pg_type</code>

		<p>存储数据类型信息。基本数据类型和枚举类型由create type创建，域类型由create domain创建，复合数据类型在表创建时自动创建。</p></li>
	<li><code>pg_attribute</code>

		<p>存储表的属性信息。</p></li>
	<li><code>pg_index</code>

		<p>存储索引的具体信息</p></li>
</ol>

<p>关键系统表之间存在依赖关系：</p>

<figure><img src="/Users/xerxes/note/postgresql/src/%E7%B3%BB%E7%BB%9F%E8%A1%A8%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB.jpg"/></figure>

<h5>系统视图</h5>

<p>除系统表之外，pg还提供了一系列内置的视图，这些视图也是在初始化数据库集簇的时候读取脚本创建的。系统视图提供了查询系统表和访问数据库内部状态的方法。</p>

<hr />

<h3>数据集簇</h3>

<p>由pg管理的用户数据库以及系统数据库总称为数据集簇。</p>

<p>在pg的实现中，数据库就是磁盘上一些文件的集合。默认情况下，pg的所有数据都存储在其数据目录里，这个数据目录通常用环境变量PGPATH来引用。</p>

<p>在pg中，对象标识符OID用来在整个数据集簇中唯一的标识一个数据库对象，这个对象可以是数据库、表、索引、视图、元组、类型等。</p>

<p>初始化数据集簇包括创建包含数据库系统所有数据的数据目录、创建共享的系统表、创建其他的配置文件和控制文件，并创建三个数据库：模版数据库template1和template0、默认的用户数据库postgres。</p>

<hr />

<h3>pg进程结构</h3>

<p>Pg使用一种专用服务器进程体系结构，其中最主要的两个进程就是守护进程postmaster和postgres。二者都是通过载入postgres程序形成的进程，只是在运行时所处的分支不同。</p>

<p>守护进程postmaster负责整个系统的启动和关闭，监听并接受客户端的连接请求，为其分配服务进程postgres。postmaster在完成基本运行环境初始化、创建接受用户请求的监听端口后，顺序启动系统辅助进程：syslogger（系统日志进程）、pgstat（统计数据收集进程）、autovacuum（系统自动清理进程）。postmaster进入到循环监听中时启动：bgwriter（后台写进程）、walwriter（预写式日志写进程）、pgarch（预写式日志归档进程）。</p>

<p>服务进程postgres接受并执行客户端发送的命令。它在底层模块（如存储、事务管理、索引等）之上调用各个主要的功能模块（如编译器、优化器、执行器等），完成客户端的各种数据库操作，并返回执行结果。</p>

<p>Pg采用C/S模式，系统为每个客户端分配一个服务进程。</p>

<h5>守护进程postmaster</h5>

<p>没看</p>

<h5>服务进程</h5>

<p>没看</p>

<h5>服务进程postgres</h5>

</body>
</html>

