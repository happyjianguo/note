<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>集群资源管理与调度</title>
	</head>
<body>
<h1>集群资源管理与调度</h1>

<p>互联网公司往往会有各种类型的工作任务，面对多种各具特性的计算系统与框架，传统的资源管理方式是采用静态资源划分方法，但是资源的整体利用率不高。如何能够设计出好的资源管理与调度的策略和方法，使得整个集群的大量资源在能够实现更高资源利用率的同时加快所有计算任务的整体完成速度，就是集群资源管理与调度系统的核心目标。</p>

<p>集群资源管理与调度策略技术尚未成熟，基本发展趋势是<strong>在集群硬件层之上抽象出一个功能独立的集群资源管理系统，将所有可用资源当作一个整体来进行管理，并对其他所有计算任务提供统一的资源管理与调度框架和接口，计算任务按需向其申请资源</strong>。</p>

<p>独立资源管理与调度的好处：</p>

<ul>
	<li>集群整体资源利用率更好</li>
	<li>可增加数据共享能力</li>
	<li>支持多类型计算框架和多版本计算框架</li>
</ul>

<hr />

<h3>资源管理抽象模型</h3>

<h5>概念模型</h5>

<figure><img src="%E6%8A%BD%E8%B1%A1%E7%9A%84%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E8%B0%83%E5%BA%A6%E6%A6%82%E5%BF%B5%E6%A8%A1%E5%9E%8B.jpg"/></figure>

<p>上图展示了一个抽象的资源管理与调度系统的概念模型。</p>

<p>从概念上讲，资源管理与调度系统的主要目的是将集群中的各种资源通过一定策略分配给用户提交到系统里的各种任务，常见的资源主要包括内存、CPU、网络资源和磁盘I/O。</p>

<p>这个概念模型主要强调三要素：资源组织模型、调度策略和任务组织模型。</p>

<p><strong>资源组织模型</strong>的主要目标是将集群中当前可用的各种资源采用一定的方式组织起来，以方便后续的资源分配过程。</p>

<p><strong>调度策略</strong>负责以一定策略将资源分配给提交到系统的任务。</p>

<p><strong>任务组织模型</strong>的主要目标是将多用户提交的多任务通过一定方式组织起来，以方便后续资源分配。</p>

<h5>通用框架</h5>

<figure><img src="%E6%8A%BD%E8%B1%A1%E7%9A%84%E9%80%9A%E7%94%A8%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6.jpg"/></figure>

<p>上图展示了一个从各种实际资源管理调度系统中抽象出来的通用资源管理框架。</p>

<p>如图，集群中每台机器上会配置节点管理器，其主要职责是不断地向资源收集器汇报目前本机资源使用情况，并负责容器的管理工作。当某个任务被分配到本节点执行时，节点管理器负责将其纳入某个机器执行并对该容器进行资源隔离，以避免不同容器内任务的相互干扰。</p>

<p><strong>通用调度器</strong>由资源收集器和资源调度策略构成，同时管理资源池和工作队列数据结构。</p>

<p><strong>资源收集器</strong>不断从集群内各个节点收集和更新资源状态信息，并将其最新状况反映到资源池中，资源池列出了目前可用的系统资源。</p>

<hr />

<h3>调度系统设计的基本问题</h3>

<h5>资源异质性与工作负责异质性</h5>

<p>异质性往往指的是组成元素构成的多元性和相互之间较大的差异性。</p>

<p><strong>资源异质性</strong>是从系统所拥有的资源角度来看，这对于大型数据中心来说是非常常见的现象，因为硬件配置的高低无法保证。</p>

<p><strong>工作负载异质性</strong>是从任务角度来看，因为各种服务和功能特性各异，对资源的需求差异也很大。</p>

<h5>数据局部性（Data Locality）</h5>

<p><strong>大数据场景下的一个基本设计原则是：将计算任务推送到数据所在地进行</strong>。</p>

<p>在资源管理与调度语境下，有三种类型的数据局部性：</p>

<ul>
	<li>节点局部性：指可以将计算任务分配到数据所在的机器节点</li>
	<li>机架局部性：虽然计算任务和所需数据分属两个不同的计算节点，但是这两个节点在同一机架</li>
	<li>全局局部性：其他的情况属于全局局部性，此时需要跨机架进行网络传输</li>
</ul>

<h5>抢占式调度与非抢占式调度</h5>

<p><strong> 抢占式调度</strong>是指对于某个计算任务来说，如果空闲资源不足或者出现不同任务共同竞争同一资源，调度系统可以从比当前计算任务优先级低的其他任务中获取已分配资源。</p>

<p><strong> 非抢占式调度</strong>只允许从空闲资源中进行分配。</p>

<h5>资源分配粒度</h5>

<p>大数据场景下的计算任务往往由两层结构构成：作业级和任务级。一个作业由多个并发的任务构成。</p>

<p>对于资源分配粒度的问题，一种极端方式是需要将作业的所有所需资源一次性分配，称为“群体分配”策略。</p>

<p>另外一种方式是采取<strong>增量满足式策略</strong>，对于某个作业来说，只要分配部分资源就能启动一些任务开始运行，随着空闲资源的不断出现，可以逐步增量式分配给作业其他任务以维持作业不断向后推进。</p>

<p>一种特殊的增量满足式分配策略被称作<strong>资源储备策略</strong>。指的是只有分配到一定量的资源作业才能启动，但是在未获得足够资源的时候，作业会先持有目前已经分配的资源，并等待其他作业释放资源，知道分配到的资源量达到最低标准后开始运行。</p>

<h5>饿死（Starvation）和死锁（Dead Lock）</h5>

<p><strong>饿死</strong>指的是计算任务持续长时间无法获得开始执行所需的最少资源，导致一直处于等待执行的状态。</p>

<p><strong>死锁</strong>是由于资源调度不当导致整个调度系统无法继续正常执行。如两个作业都采用“资源储备策略”，就会发生死锁。</p>

<h5>资源隔离方法</h5>

<p>相比Hadoop1.0的Map和Reduce槽（Slot）的粗粒度资源分配方式，无论是YARN还是Mesos都采取了将各种资源封装在容器中的细粒度资源分配方法。</p>

<p>目前对于资源隔离最常用的手段是Linux容器（Linux Container，LXC），YARN和Mesos都采用了这种方式来实现资源隔离。通过LXC可以在一台物理主机上隔离出多个相互隔离的容器。</p>

<hr />

<h3>资源管理与调度系统范型</h3>

<p>目前实现的资源管理与调度系统范型根据宏观运行机制的不同可以分为三类：集中式调度器、两级调度器和状态共享调度器。</p>

<figure><img src="%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E4%B8%8E%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F%E8%8C%83%E5%9E%8B.jpg"/></figure>

<h5>集中式调度器</h5>

<p>集中式调度器在整个系统中只运行一个全局的中央调度器实例，所有之上的框架或者计算任务的资源请求全部经由中央调度器来满足。</p>

<h5>两级调度器</h5>

<p>两级调度器将整个系统的调度工作划分为两个级别：中央调度器和框架调度器。</p>

<p><strong>中央调度器</strong>可以看到集群中所有机器的可用资源并管理其状态，它可以按照一定策略将集群中的所有资源分配给各个计算框架，其资源调度是一种粗粒度的资源调度方式。<br/>两级调度器由于在计算框架层面存在第二级资源调度，可以提供一种比较天然的并发性，所以整体调度性能较好，也适合大规模集群下的多任务高负载计算情形。</p>

<h5>状态共享调度器</h5>

<p>每个计算框架可以看到整个集群中的所有资源，并采用相互竞争的方式去获取自己所需的资源，根据自身特性采取不同的具体资源调度策略，同时系统采用了乐观并发控制手段级解决不同框架在资源竞争过程中出现的需求冲突。</p>

<hr />

<h3>资源调度策略</h3>

<h5>FIFO调度策略</h5>

<p>FIFO策略是最简单的资源调度策略，提交的作业按照提交时间先后顺序或者根据优先级次序将其放入线性队列相应位置，在资源调度时按照队列先后顺序，先进先出地进行资源分配。</p>

<h5>公平调度器</h5>

<p>将用户的任务分配到多个资源池，每个资源池设定资源分配最低保障和最高上限，管理员也可以指定资源池的优先级，优先级高的资源池会被分配更多资源。当一个资源池资源有剩余时，可以临时将剩余资源共享给其他资源池。</p>

<h5>能力调度器</h5>

<p>将用户和任务组织成多个队列，每个队列可以设定资源最低保障和使用上限，当一个队列的资源有剩余时，可以将剩余资源暂时分享给其他队列。</p>

<p>调度器在调度时，优先将资源分配给资源使用率最低的队列；在队列内部，按照作业优先级的先后顺序遵循FIFO策略进行调度。</p>

<h5>延迟调度策略</h5>

<p>不是一个独立的调度方式，往往会作为其他调度策略的辅助措施来增加调度的数据局部性，增加任务执行效率。</p>

<p>对于当前被调度到要被分配资源的任务i，如果当前资源不满足数据局部性，那么可以暂时放弃分配公平性，任务i不接受当前资源，而是等待后续的资源分配；当前资源可以跳过任务i分配给其他待调度任务，如果任务i在被跳过k次后仍然等不到满足局部性的资源，则放弃数据局部性。</p>

<h5>主资源公平调度策略（Dominant Resource Fair Scheduling）</h5>

<p>DRF是Mesos中央调度器采用的公平调度策略，也是最大最小公平算法的一个具体体现。</p>

<p><strong>最大最小公平算法</strong>的基本思想：最大化目前分配到最少资源量的用户或者任务的资源量。这个算法常常用来对单个资源进行公平分配，而DRF则将其扩展到了多个资源的公平分配场景下。</p>

<hr />

<h3>Mesos</h3>

<p>从其范型来看是一个典型的两级调度器。</p>

<p>Mesos的设计哲学吸收了类似操作系统中微内核的思想，在中央调度器一级采取极简功能和极小接口，只是根据一定策略决定分配给各个框架多少资源，将数据局部性保证等具体资源调度策略下推到各个框架，这样可以减少中央调度器的负载，增加调度效率，并且增加了调度系统的可扩展性和健壮性。</p>

<p>Mesos的整体架构采用了典型的主-从架构。中央调度器由多个主控服务器构成，通过ZooKeeper保证当前正在工作的主控服务器出现故障时，备用主控服务器可以快速接替管理工作。</p>

<figure><img src="Mesos%E6%9E%B6%E6%9E%84.jpg"/></figure>

<p>主控服务器使用“资源供应”来将集群内的资源分配给各个计算框架，每份“资源供应”代表了一部分集群内可用的资源列表。主控服务器通过“资源供应”决定为每个框架提供多少资源，每个框架自身的二级调度器做更细致的任务间资源分配。</p>

<p>每个计算框架都需要向Mesos注册两个接口：框架调度器和执行器。<strong>框架调度器起到两级调度器中第二级调度器的功能</strong>，中央调度器将“资源供应”提交给框架调度器，框架调度器再按照自己的资源分配策略将其分配给自身的任务。<strong>执行器运行在集群中的从节点中执行具体任务</strong>，执行器相互之间的资源隔离由Mesos通过Linux Container来获得保证。</p>

<hr />

<h3>YARN</h3>

<p>YARN是Hadoop2.0的重要组成部分，全称“另一个资源调度器（Yet Another Resource Negotiator）”，是一个独立的资源管理系统。</p>

<p>YARN的<strong>资源管理器（Resource Manager，RM）</strong>负责整个集群的资源管理功能，每个任务都单独有一个<strong>应用服务器（Application Master，AM）</strong>来负责完成任务所需资源的申请管理与任务生命周期管理功能。</p>

<p>从资源管理系统范型来看，YARN是个典型的二级调度器，其中RM类似于主控服务器，充当中央调度器的功能。每个任务的AM类似于二级调度器。</p>

<p>AM负责向RM申请作业所需资源，并在作业的众多任务中进行资源分配与协调。</p>

<h5>架构</h5>

<figure><img src="YARN%E6%9E%B6%E6%9E%84.jpg"/></figure>

<p>YARN主要构件包括：唯一的资源管理器RM、每个作业的应用服务器AM以及每个机器一个的节点管理器NM。</p>

<p>RM负责全局的资源管理工作，其内部主要功能部件包括：调度器、AM服务器、Client-RM接口以及RM-NM接口。</p>

<p>AM负责向RM申请启动任务所需的资源，同时协调作业内各个任务的运行过程。</p>

<p>NM是YARN中在每台机器上都部署的节点管理器，主要负责机器内容器资源的管理，比如容器间的依赖关系、监控容器执行以及为容器提供资源隔离等各种服务。</p>

<h5>任务执行过程</h5>

<figure><img src="YARN%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.jpg"/></figure>

<ol>
	<li>用户通过客户端向YARN提交作业</li>
	<li>RM通过调度器申请资源，用于启动运行作业的AM；如果申请到，则AMS负责通知节点管理器在相应容器内启动执行AM</li>
	<li>AM负责将作业划分为若干任务，并向RM请求启动任务所需的资源；RM接收到请求后，通过调度器分配资源，找到合适的容器，将这些资源信息返回给AM</li>
	<li>AM根据资源信息，在任务间优化资源分配策略，确定后直接与资源所在的节点管理器联系，在对应的容器中启动任务，节点管理器负责容器的资源隔离</li>
	<li>AM在部分任务执行完成后逐步向RM释放所占资源</li>
</ol>

</body>
</html>

