<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>分布式通信</title>
	</head>
<body>
<h1>分布式通信</h1>

<p>分布式通信研究分布式系统中不同构件（子系统或者进程）之间的信息交换机制。</p>

<hr />

<h3>序列化与远程过程调用框架</h3>

<p>许多分布式系统是在进程间显示地进行消息交换的，这里面比较复杂的一点在于消息发送和接收时的通信过程管理，而通信细节的隐藏对于分布式系统中实现访问透明性是极为重要的，远程过程调用（Remote Procedure Call，RPC）即可简化这一通信过程。</p>

<p>RPC允许程序调用位于网络中其他机器上的进程，当机器A上的进程调用机器B上的进程时，A的调用进程被挂起，而B上的被调用进程开始执行，调用方可以通过参数将信息传递给被调用方，然后通过B上的进程返回的结果得到所需的信息。RPC通过以上机制可以隐藏下层的具体通信过程，这大大简化并透明化了网络间进程调用过程，是大规模分布式系统中位于不同机器上进程间通信的粘合剂。</p>

<p>一般RPC框架会融合数据序列化与反序列化功能，以实现高效的数据存取与通信。</p>

<p>通用的序列化与RPC框架都支持以下特性：接口描述语言（Interface Description Language，IDL）、高性能、数据版本支持以及二进制数据格式。</p>

<h5>Protocol Buffer与Thrift</h5>

<p>PB是在Google内部广泛使用的序列化与RPC框架，是几乎所有Google服务的粘合剂。Google内部版本的PB包含RPC框架实现，但是开源官方版并未提供这一功能，仅提供了RPC调用接口，所以其开源版本被更多的应用与数据序列化方面。</p>

<p>Thrift则是Facebook开源出的序列化与RPC矿机，在Facebook内部也得到了广泛的使用。Thrift可以支持十几种常见编程语言，同时也直接提供RPC调用框架服务。因为RPC功能以及IDL语言比PB表达能力更强（Thrift支持List/Map复杂数据结构，PB不支持），所以Thrift的使用场景更丰富，所以很多开源系统融入Thrift作为RPC构件。</p>

<p><strong>使用流程</strong>：</p>

<p>首先，使用IDL定义消息体以及RPC函数调用接口。IDL是与编程语言无关的接口描述语言，定义调用方和被调用方都一致遵循的数据结构和接口，在调用方和被调用方之间实现解耦。</p>

<p>其次，使用工具根据上步的IDL定义文件生成指定编程语言的代码。</p>

<p>最后，即可在应用程序中链接使用上一步生成的代码。对于RPC功能来说，调用方和被调用方同时引入后即可实现透明网络访问，如果调用方和被调用方采取不同的语言，只要分别根据IDL定义文件生成不同语言库即可实现两者的解耦。</p>

<h5>Avro</h5>

<p>Avro是Apache开源的序列化与RPC框架，使用在Hadoop的数据存储与内部通信中。Avro使用JSON作为IDL定义语言，可以灵活地定义数据Schema及RPC通信协议，提供了简洁快速的二进制数据格式，并能和动态语言进行集成。</p>

<p>Avro的IDL语言支持基本数据类型，和Record、Array、Map等复杂数据类型。</p>

<p>数据Schema使用JSON描述并存放在数据文件的起始部分。</p>

<p>数据以二进制形式存储，进行数据序列化和反序列化时速度快，占用额外存储空间少。</p>

<p>Avro功能上和PB、Thrift类似，不同之处：支持动态语言集成；数据Schema独立于数据并在序列化时置于数据之首；其IDL使用JSON表达，无需额外定制IDL解析器。</p>

<hr />

<h3>消息队列</h3>

<p>参考<code>/Users/xerxes/note/messageQueue</code></p>

<hr />

<h3>应用层多播通信（Application-Level Multi-Broadcast）</h3>

<h5>概述</h5>

<p>分布式系统中一个重要的研究内容是<strong>如何将数据通知到网络中多个接收方，称为多播</strong>。</p>

<p>所谓应用层多播通信，指的是<strong>分布式应用系统内各个节点组织成一定的组织结构，在此结构上实现多接收方的数据通信</strong>。</p>

<p>在P2P网络中，分布式应用层的节点常见的组织结构有<strong>星型结构</strong>、<strong>DHT（Distributed Hash Table）环形结构</strong>和<strong>树形结构</strong>，也有<strong>无结构</strong>的情形，即任意节点之间可以随意相连，从宏观上看并无明显结构。在无结构情形下，一种原始实现多播通信的方式是某个节点通知所有喝了其有直接连接的其他节点，其他节点再依次传播给他们自己的邻居节点。</p>

<h5>Gossip协议</h5>

<p>也称<strong>感染协议（Epidemic Protocol）</strong>。</p>

<p>Gossip协议在大数据系统中有广泛的应用，用来进行故障检测、集群成员管理、副本数据修复、节点之间交换信息、维护主备数据的最终一致性以及负载均衡。</p>

<ol>
	<li>信息传播模型Gossip协议用来尽快将本地更新数据通知到网络中的所有其他节点。其具体更新模型又分为三种：

		<ul>
			<li>全部通知模型（Best Effort或Direct Mail）

				<p>当某个节点有更新消息，立即通知所有其他节点；其他节点在接收到通知后，可以通过时间戳或者版本信息来判断接收到的消息是否比本地消息更新；如果是则更新本地数据，否则不更新。</p>

				<p>缺点：容错不好，通知过程发生故障或者消息在通信过程中丢失都会造成集群中有些节点无法获知最新数据</p></li>
			<li>反熵模型（Anti-Entropy）

				<p>最常用的Gossip协议。<strong>熵</strong>是信息论里用来衡量系统混乱无序程度的指标，熵越大说明系统越无序，包含的有用信息含量越少。<strong>反熵</strong>的物理含义：因为更新的信息经过一定轮数的传播后，集群内所有节点都会获得全局最新消息，所以系统变得越来越有序。</p>

				<p>在反熵模型中，节点P随机选择集群中另外一个节点Q，然后与Q交换更新消息；Q如果信息有更新，则类似P一样传播给任意其他节点（此时P也可以再传播给其他节点），这样经过一定轮数的信息交换，更新的信息就会快速传播到整个网络节点。反熵模型中交换信息的方法有三种：</p>

				<ul>
					<li>Push模式：P的更新消息推送给Q，Q判断是否比本地信息更新，如果是，则更新本地信息</li>
					<li>Pull模式：P从Q获取其信息，如果比P本地信息更新，则P更新本地信息。即P从Q处获得最新内容</li>
					<li>Push-Pull模式：P和Q同时进行Push和Pull操作，互相通知对方更新</li>
				</ul>

				<p>Push模式和Pull模式相比，刚开始Push比Pull传播快，越往后Pull方式比Push越快，所以整体而言Pull模式传播效率要高于Push模式。</p>

				<ul>
					<li>对于Push模式来说，其本质是去主动通知其他未更新的节点，在刚开始的时候随机选择节点时，有很大概率选择的节点尚未获得更新，所以传播起来比较有效率，但是当有相当一部分节点已经获得更新后，随机选择节点很大的概率是选择已经获得更新的节点，因此效率变低</li>
					<li>而Pull模式正好相反，其本质是从其他节点获得更新，到后期的时候因为有越来越多的节点获得了更新，所以其获得更新的概率越来越大，其整体更新速度越来越快</li>
				</ul></li>
			<li>散布谣言模型（Rumor Mongering）

				<p>和反熵模型相比增加了传播停止判断。流程：如果节点P更新数据，则随机选择节点Q交换信息：如果节点Q已经被其他节点通知更新了，那么节点P则增加其不再主动通知其他节点的概率，到了一定程度，比如不在通知其他节点的概率达到一定值，则节点P停止通知行为。</p>

				<p>散布谣言模型是快速传播变化的好方法，但是有个缺点：他不能保证所有节点都能最终获得更新，因此在实践中不如反熵模型常用。</p></li>
		</ul></li>
	<li>应用：Cassandra集群管理

		<p>Cassandra是P2P的列式数据库集群，因为P2P架构无中心管理节点，所以对于是否新加入了机器节点、是否有机器宕机等机器状态信息的维护不可能依赖主控节点来完成。因此Cassandra使用Gossip协议来维护集群中机器节点状态信息，这样每个节点都可以最终一致获得整个集群其他节点的全局状态。</p>

		<p>Cassandra本质上是使用反熵协议中的Push-Pull模式在节点之间交换最新状态信息。</p></li>
</ol>

</body>
</html>

