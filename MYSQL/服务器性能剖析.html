<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>服务器性能剖析</title>
	</head>
<body>
<h1>服务器性能剖析</h1>

<h3>性能优化简介</h3>

<blockquote>
<p>我们将性能定义为完成某件任务所需要的时间度量。</p>
</blockquote>

<ol>
	<li>原则一：性能即响应时间。</li>
	<li>原则二：无法测量就无法优化。</li>
</ol>

<h3>通过性能剖析进行优化</h3>

<p>性能剖析时测量和分析时间花费在哪里的主要方法。性能剖析一般有两个步骤：</p>

<ol>
	<li>测量任务所花费的时间</li>
	<li>然后对结果进行统计和排序</li>
</ol>

<p>我们将实际地讨论两种类型的性能剖析：基于执行时间的分析和基于等待的分析。</p>

<p>基于执行时间的分析研究的是什么任务的执行时间最长，而基于等待的分析则是判断任务在什么地方被阻塞的时间最长。</p>

<p>在对系统进行性能剖析前，必须先要能够进行测量，这需要系统可测量化的支持。</p>

<h3>理解性能剖析</h3>

<h6>值得优化的查询</h6>

<ol>
	<li>一些只占总响应时间比重很小的查询是不值得优化的。</li>
	<li>如果优化的成本大于收益，就应当停止优化。</li>
	<li>某些任务即使没有出现在性能剖析输出的前面也需要优化。（比如某些执行次数少，但是每次执行都特别慢，影响用户体验的任务。）</li>
	<li>一款好的性能剖析工具会显示可能的‘丢失的事件’。</li>
	<li>性能剖析无法显示所有响应时间的分布，平均值大部分情况下是不能相信的。</li>
</ol>

<h6>对应用程序进行性能剖析</h6>

<blockquote>
<p>剖析应用程序一般比剖析数据库服务器容易，而且回报更多。</p>

<p>对系统进行性能剖析建议自上而下地进行，这样可以追踪自用户发起到服务器响应的整个流程。</p>
</blockquote>

<h3>剖析服务器负载</h3>

<h6>捕获MySQL的查询到日志文件中</h6>

<ol>
	<li>慢查询日志是开销最低、精度最高的测量查询时间的工具。如果要长期开启慢查询日志，注意要部署日志轮转工具。</li>
	<li>通用日志很少用于分析和剖析服务器性能。通用日志在查询请求到服务器时进行记录，所以不包含响应时间和执行计划等重要信息。</li>
	<li>如果权限不足，无法在服务器上记录查询：

		<ol>
			<li>通过 <code>--processlist</code>选项不断查看<code>show full processlist</code>的输出，记录查询第一次出现的时间和消失的时间。</li>
			<li>通过抓取TCP网络包，根据MySQL的客户端／服务端通信协议进行解析。</li>
		</ol></li>
</ol>

<h6>SHOW PROFILE</h6>

<p>在语句执行期间剖析服务器的具体工作。</p>

<p><code>show profile for query {id}</code>可以给出查询执行的每个步骤及其花费时间，但很难快速确定哪个步骤花费的时间最多。因此可以直接从<code>INFORMATION_SCHEMA.PROFILING</code>查询数据并给结果排序。</p>

<h6>SHOW STATUS</h6>

<p>返回一些计数器。可以显示某些活动如读索引的频繁程度，但是无法给出消耗了多少时间。</p>

<h6>SHOW PROCESSLIST</h6>

<p>通过不停地捕获<code>SHOW PROCESSLIST</code>来观察是否有大量线程处于不正常的状态。</p>

<h6>捕获诊断数据</h6>

<p>当出现间歇性问题时，需要尽可能多地收集所有数据，而不是问题出现时的数据。</p>

<ol>
	<li>触发器是问题出现时能够捕获数据的基础。开始收集数据前多花一点时间来确认触发器能够真正地识别问题，避免‘误报’和‘捡漏’。</li>
	<li>选择工具或编写脚本在达到触发条件时能够收集数据。</li>
</ol>

<p>在需要的时间段内收集尽可能多地数据，包括系统的状态、CPU利用率、磁盘使用率和可用空间、ps的输出采样、内存利用率以及从MySQL获得的信息。</p>

</body>
</html>

